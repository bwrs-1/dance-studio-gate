"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("axios"),e=require("js-cookie"),n=require("uuid");function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=r(t),o=r(e),s=function(){return s=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},s.apply(this,arguments)};function a(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]])}return n}function c(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function u(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var l=function(t){return t.replace(/[A-Z]/g,(function(t){return"_"+t.charAt(0).toLowerCase()})).replace(/^_(.+?)$/,"$1")},d=function(t){return t.replace(/_./g,(function(t){return t.charAt(1).toUpperCase()}))},f=function(t){if(!t||"object"!=typeof t)return t;if(t instanceof Date||t instanceof RegExp)return t;if(Array.isArray(t)){var e=[];return t.forEach((function(t){return e.push(f(t))})),e}var n={};return Object.keys(t).forEach((function(e){var r=d(e);n[r]=f(t[e])}),{}),n},p=function(t){var e=t.values,n=t.attributes.fields.data.map((function(t){if("calendar"!==t.attributes.inputType)return t;var n=new Date(t.attributes.value);return e[t.attributes.identifier]=n,s(s({},t),{value:n})}));return s(s({},t),{values:e,attributes:s(s({},t.attributes),{fields:{data:n},createdAt:new Date(t.attributes.createdAt),updatedAt:new Date(t.attributes.updatedAt),publishedAt:new Date(t.attributes.publishedAt)})})},h=function(){function t(t){void 0===t&&(t="analytics.spearly.com"),this.client=i.default.create({baseURL:"https://"+t})}return t.prototype.postMetric=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,this.client.post("/metrics",{metric:{name:t.name,properties:{resource_type:"content",resource_id:t.contentId,pattern_name:t.patternName,value:t.value,distinct_id:t.distinctId,session_id:t.sessionId,session_id_expires_in:t.sessionIdExpiresIn}}})];case 1:return[2,e.sent()]}}))}))},t}(),v=function(){function t(t){this.client=new h(t),this.distinctId=this.setDistinctId(),this.sessionId=this.setSessionId()}return t.prototype.pageView=function(t){return c(this,void 0,void 0,(function(){var e,n,r;return u(this,(function(i){switch(i.label){case 0:return e=t.patternName,n=t.contentId,r=(null==t?void 0:t.expires)||1800,this.setDistinctId(),this.setSessionId(),[4,this.client.postMetric({name:"impressions",contentId:n,patternName:e,value:1,distinctId:this.distinctId,sessionId:this.sessionId,sessionIdExpiresIn:r})];case 1:return i.sent(),[2]}}))}))},t.prototype.conversion=function(t){return c(this,void 0,void 0,(function(){var e,n;return u(this,(function(r){switch(r.label){case 0:return e=t.patternName,n=t.contentId,this.setDistinctId(),[4,this.client.postMetric({name:"conversions",contentId:n,patternName:e,value:1,distinctId:this.distinctId})];case 1:return r.sent(),[2]}}))}))},t.prototype.setDistinctId=function(){var t=this.getCookie("spearly_distinct_id")||n.v4(),e=new Date(Date.now()+31536e6).getTime();return this.setCookie("spearly_distinct_id",t,e),t},t.prototype.setSessionId=function(t){void 0===t&&(t=1800);var e=this.getCookie("spearly_session_id")||n.v4(),r=new Date(Date.now()+1e3*t).getTime();return this.setCookie("spearly_session_id",e,r),e},t.prototype.setCookie=function(t,e,n){o.default.set(t,e,{expires:n,path:"/"})},t.prototype.getCookie=function(t){return o.default.get(t)},t}(),y=function(){function t(t,e,n){this.client=i.default.create({baseURL:"https://"+(e||"api.spearly.com"),headers:{Accept:"application/vnd.spearly.v2+json",Authorization:"Bearer "+t}}),this.analytics=new v(n)}return t.prototype.getRequest=function(t,e){return void 0===e&&(e=""),c(this,void 0,void 0,(function(){var n,r;return u(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this.client.get(""+t+e)];case 1:return n=i.sent(),[2,f(n.data)];case 2:return r=i.sent(),[2,Promise.reject(r)];case 3:return[2]}}))}))},t.prototype.postRequest=function(t,e){return c(this,void 0,void 0,(function(){var n,r;return u(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this.client.post(t,e)];case 1:return n=i.sent(),[2,f(n.data)];case 2:return r=i.sent(),[2,Promise.reject(r)];case 3:return[2]}}))}))},t.prototype.getList=function(t,e){return void 0===e&&(e={}),c(this,void 0,void 0,(function(){var n,r;return u(this,(function(i){switch(i.label){case 0:return e.distinctId=e.distinctId?e.distinctId:this.analytics.distinctId,n=this.toListParams(e),[4,this.getRequest("/content_types/"+t+"/contents",n)];case 1:return r=i.sent(),[2,(o=r,s(s({},o),{data:o.data.map((function(t){return p(t)}))}))]}var o}))}))},t.prototype.getContent=function(t,e,n){return void 0===n&&(n={}),c(this,void 0,void 0,(function(){var r,i;return u(this,(function(o){switch(o.label){case 0:return n.distinctId=n.distinctId?n.distinctId:this.analytics.distinctId,r=this.toContentParams(n),[4,this.getRequest("/content_types/"+t+"/contents/"+e,r)];case 1:return i=o.sent(),[2,p(i.data)]}}))}))},t.prototype.getContentPreview=function(t,e,n){return c(this,void 0,void 0,(function(){var r;return u(this,(function(i){switch(i.label){case 0:return[4,this.getRequest("/content_types/"+t+"/contents/"+e,"?preview_token="+n)];case 1:return r=i.sent(),[2,p(r.data)]}}))}))},t.prototype.getFormLatest=function(t){return c(this,void 0,void 0,(function(){var e;return u(this,(function(n){switch(n.label){case 0:return[4,this.getRequest("/forms/"+t+"/latest")];case 1:return e=n.sent(),[2,(r=e.form,i=r.confirmationEmailEnabled,o=r.confirmationEmailName,c=r.confirmationEmailDescription,u=r.confirmationScreenBeforeSubmitEnabled,l=r.backButtonLabel,d=r.submitButtonLabel,f=a(r,["confirmationEmailEnabled","confirmationEmailName","confirmationEmailDescription","confirmationScreenBeforeSubmitEnabled","backButtonLabel","submitButtonLabel"]),s(s({},f),{startedAt:r.startedAt?new Date(r.startedAt):null,endedAt:r.endedAt?new Date(r.endedAt):null,createdAt:new Date(r.createdAt),confirmationEmail:{enabled:i,name:o,description:c},confirmationScreen:{enabled:u,backButtonLabel:l||"",submitButtonLabel:d||""}}))]}var r,i,o,c,u,l,d,f}))}))},t.prototype.postFormAnswers=function(t,e){return c(this,void 0,void 0,(function(){var n,r,i,o;return u(this,(function(c){switch(c.label){case 0:if(!("_spearly_gotcha"in e))throw new Error('Include "_spearly_gotcha" in the fields.');return n=e._spearly_gotcha,r=e.confirmation_email,i=a(e,["_spearly_gotcha","confirmation_email"]),[4,this.postRequest("/form_answers",{form_version_id:t,fields:i,_spearly_gotcha:n,confirmation_email:r})];case 1:return o=c.sent(),[2,(u=o.answer,s(s({},u),{createdAt:new Date(u.createdAt)}))]}var u}))}))},t.prototype.toListParams=function(t){if(void 0===t&&(t={}),!Object.keys(t).length)return"";var e="?";return Object.keys(t).forEach((function(n){var r=n,i=l(r);if("number"==typeof t[r])e+=i+"="+String(t[r])+"&";else if(t[r]instanceof Date){var o=t[r].getFullYear(),s=String(t[r].getMonth()+1),a=String(t[r].getDate());e+=i+"="+o+"-"+s.padStart(2,"0")+"-"+a.padStart(2,"0")+"&"}else if("orders"===r){var c=t[r];Object.keys(c).forEach((function(t){e+="order_by_"+t+"="+c[t]+"&"}))}else if("filterValue"===r&&t[r]&&t[r]instanceof Array){t[r].forEach((function(t){e+="filter_value[]="+t+"&"}))}else if("filters"===r){var u=t[r];Object.keys(u).forEach((function(t){u[t]instanceof Array?u[t].forEach((function(n){e+="filter_by_"+t+"[]="+n+"&"})):e+="filter_by_"+t+"="+u[t]+"&"}))}else e+=i+"="+t[r]+"&"})),e.slice(0,-1)},t.prototype.toContentParams=function(t){if(void 0===t&&(t={}),!Object.keys(t).length)return"";var e="?";return t.distinctId&&(e+="distinct_id="+t.distinctId+"&"),t.patternName&&(e+="pattern_name="+t.patternName+"&"),e.slice(0,-1)},t}();exports.SpearlyAnalytics=v,exports.SpearlyAnalyticsApiClient=h,exports.SpearlyApiClient=y,exports.camelToSnake=l,exports.recursiveToCamels=f,exports.snakeToCamel=d;
